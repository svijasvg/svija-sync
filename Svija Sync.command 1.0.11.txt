#!/usr/bin/env bash
#———————————————————————————————————————— config

x

#———————————————————————————————————————— instructions
#
#   https://github.com/svijasvg/svija-sync
#
#———————————————————————————————————————— language independent

version='Svija Sync V1.0.12'

sync_folder='sync'
none='\e[0;0m'
red='\e[1;91m'

#———————————————————————————————————————— localized english

keyup='U'
keydown='D'
keyyes='Y'
keyno='N'

      on='on'
computer='your computer'
   wsite='site'
  server='website'
  folder='folder'
 replace='Synchronizing'
complete='Syncronisation complete'
    with='with'
    from='content of'
downloading='Downloading from'
do_not_close='Do not close this window.'

   close=$red"Quit Terminal$none to close"
close_lc=$red"quit Terminal$none to close"
canceled="$red""Synchronisation canceled — $close_lc.$none\n"

instructions="    $version
    $red$server: $site
    user: $user
$none
    $computer -> $wsite   $red$keyup$none""pload
    $computer <- $wsite   $red$keydown$none""ownload

Choose an option (return to cancel):"

warning="$red""Replace $folder \"$sync_folder\" $on $computer$none — are you sure? [$keyyes/$keyno]:"

invalid="Invalid choice — $close_lc.
         $red$keyup=uploader  $keydown=downloader:$none"

#———————————————————————————————————————— no localization needed

interval=5
continuous='|'

uploading="$replace $site $with \"$sync_folder\" $on $computer..."
downloading="$downloading $folder \"$sync_folder\" $on $site...\n$do_not_close"

ubuntu="$user@$site::$user/$sync_folder"

#———————————————————————————————————————— rsync exclusions

exclusions=(
  --exclude ".DS_Store"
  --exclude ".swp"
  --exclude ".git"
  --exclude ".command"
  --exclude ".pwd"
)

#————————————————————————————————————————  fix svg names
# renames "svg_name 2.svg" to "svg_name.svg"

fix_names(){
  sync_dirs=(sync/*)
  
  for f in "${sync_dirs[@]}"; do
    sub_dirs=("$f"/*.svg)
    for g in "${sub_dirs[@]}"; do
  
      [[ $g =~ ^.+\s\d\.svg ]] && echo matched
  
      regexp="^.+[[:space:]][[:digit:]]\.svg"
      if [[ $g =~ $regexp ]]
        then
          new_name="${g::${#g}-6}"".svg"
          mv "$g" "$new_name"
      fi
  
    done
  done
}

#———————————————————————————————————————— change to correct directory

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
cd "${DIR}"

#———————————————————————————————————————— choice of synchronization

printf "\n\n$instructions ";
read flag; flag=$(echo "$flag" | tr a-z A-Z)

#———————————————————————————————————————— invalid input

while [[ "$flag" != "" ]] && [[ $flag != $keyup ]] && [[ $flag != $keydown ]]; do
  printf "\n$invalid ";
  read flag; flag=$(echo "$flag" | tr a-z A-Z)
done

#———————————————————————————————————————— confirm download

if [[ $flag == $keydown ]]; then
  printf "\n$warning ";
  read confirmation; confirmation=$(echo "$confirmation" | tr a-z A-Z)
  if [[ $confirmation != $keyyes ]]; then
    flag=''
  fi
fi

#———————————————————————————————————————— create password file

pwd_file='.rsync.pwd'
echo $pass > $pwd_file
chmod 600 $pwd_file

#———————————————————————————————————————— execute the sync

case "$flag" in

$keyup)
  printf "\n$uploading\n\n    $close\n    "
  counter=0
  while true
    do
      if [ $counter == "60" ]; then
		counter=0
		printf "\n    "
      fi
      counter=$((counter+1))
      fix_names
      rsync -az --delete "${exclusions[@]}" --password-file=$pwd_file "$sync_folder/" $ubuntu
      printf "$continuous"
      sleep $interval
    done
  printf "n$complete.\n"
  ;;

$keydown)
  printf "\n$downloading\n"
  rsync -az --delete "${exclusions[@]}" --password-file=$pwd_file "$ubuntu/" $sync_folder
  printf "\n$complete — "
  ;;
esac

#———————————————————————————————————————— canceled

if [[ $flag != '' ]]; then
  printf "$close_lc.\n"
  read x
else
  printf "\n$canceled\n"
fi

killall Terminal

#———————————————————————————————————————— fin
